<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Grid</title>
	<style type="text/css">
	body {
		margin: 0;
		overflow: hidden;
	}

	#canvasContainer {
		display: block;
		width: 480px;
		height: 480px;
		margin: 50px auto;
		border: 1px solid #ccc;
		padding: 1px;
	}
	</style>
	<script type="text/javascript" src="signals.min.js"></script>
	<script type="text/javascript" src="hasher.min.js"></script>
	<script type="text/javascript" src='bean.min.js'></script>
	<script type="text/javascript">
		var alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";
		var zoom = 30,
			size = 16,
			values = [],
			imageData, canvas, context;
		
		for (var i = 0; i < size * size; i++) {
			values.push(false);
		}

		bean.add(document, 'DOMContentLoaded', function() {
			canvas = document.getElementById("canvas");
			context = canvas.getContext("2d");
			imageData = context.createImageData(16, 16);
			console.log(imageData.data.length);


			// event handling

			var pen = null;
			bean.add(canvas, 'mousedown', function(e) {
				var i = getIndex(e);
				console.log(i);
				pen = values[i] = !values[i];
				bean.fire(document, 'pxchange', [i, pen]);
			});

			bean.add(canvas, 'mousemove', function(e) {
				if (pen !== null) {
					var i = getIndex(e);
					if (values[i] !== pen) {
						values[i] = pen;
						bean.fire(document, 'pxchange', [i, pen])
					}
				}
			})

			bean.add(document, 'mouseup', function(e) {
				pen = null;
				console.log('up');
				hasher.setHash(pickle()); //change hash value (generates new history record)
			})

			bean.add(document, 'pxchange', function(i, b) {
				console.log([i, b])
				setPixel(i, b);
			})

			hasher.changed.add(handleChanges); 
 			hasher.initialized.add(handleChanges);
			hasher.init(); //initialize hasher (start listening for history changes)

		});

		function getIndex(e) {
			return Math.floor(e.offsetY / zoom) * size + Math.floor(e.offsetX / zoom)
		}

		function setPixel(i, c) {
			var x = i % size;
			var y = Math.floor(i / size);
			console.log([i, x, y])
			context.fillStyle = (c ? 'black' : 'white');
			context.fillRect(x * zoom, y * zoom, zoom, zoom);
		}

		function pickle() {
			s = ''
			for(var i = 0; i < values.length; i += 6) {
				var v = 0;
				for (var j = 0; j < 6 && i + j < values.length; j++) {
					var v = v | values[i + j] << j;
				}
				s += alphabet[v];
			}
			return s;
		}

		function unpickle(s) {
			for (var i = 0; i < s.length; i++) {
				var v = alphabet.indexOf(s[i]);
				for (var j = 0; j < 6; j++) {
					var b = (v >> j) & 1;
					var index = i * 6 + j;
					if (index < values.length && values[index] !== b) {
						values[index] = b;
						bean.fire(document, 'pxchange', [index, b])
					}
				}
			}
		}

		function handleChanges(newHash, oldHash){
			console.log(newHash);
			unpickle(newHash);
		}


	</script>
</head>
<body>
	<div id='canvasContainer'>
		<canvas id="canvas" width='480px' height='480px'></canvas>
	</div>
</body>
</html>