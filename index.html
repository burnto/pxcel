<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Grid</title>
	<style type="text/css">
	body {
		margin: 0;
		overflow: hidden;
	}

	#canvasContainer {
		display: block;
		width: 480px;
		margin: 50px auto;
	}
	</style>
	<script type="text/javascript" src="signals.min.js"></script>
	<script type="text/javascript" src="hasher.min.js"></script>
	<script type="text/javascript" src="paper.js"></script>
	<script type="text/paperscript" canvas="canvas">
		/////////////////////////////////////////////////////////////////////
		// Values

		var alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";
		var zoom = 30;
		var size = 16;
		var values = [];
		var squares = [];

		for(var y = 0; y < size; y++) {
			for(var x = 0; x < size; x++) {
				var p = new Point(x, y) * zoom;
				var rect = new Rectangle(p, p + zoom);
				var rectPath = new Path.Rectangle(rect);
				rectPath.fillColor = "white";
				rectPath.index = y * size + x;
				values.push(false);
				squares.push(rectPath);
				console.log(x + ", " + y)
			}
		}

		var hitOptions = {
		    segments: false,
		    stroke: false,
		    fill: true,
		    tolerance: 0
		};

		function pickle() {
			s = ''
			for(var i = 0; i < values.length; i += 6) {
				var v = 0;
				for (var j = 0; j < 6 && i + j < values.length; j++) {
					var v = v | values[i + j] << j;
				}
				s += alphabet[v];
			}
			return s;
		}

		function unpickle(s) {
			values = [];
			num = size * size;
			for (var i = 0; i < s.length; i++) {
				var v = alphabet.indexOf(s[i]);
				for (var j = 0; j < 6; j++) {
					// console.log(v + ", " + (v & (1 << j)));
					var b = (v >> j) & 1;
					// console.log(v + ", " + j + ": " + b);
					values.push(b);
				}
			}
			while(values.length < num) {
				values.push(false);
			}
			for (var i = 0; i < squares.length; i++) {
				squares[i].fillColor = values[i]
			}
			return values;
		}

		function set(item, color) {
			if(item.fillColor != color) {
	    		values[item.index] = (color === 1);
				hasher.setHash(pickle()); //change hash value (generates new history record)
			}
		}

		function onMouseDown(event) {
		    var hitResult = project.hitTest(event.point, hitOptions);
		    if (hitResult) {
	    		pen = hitResult.item.fillColor.gray == 1 ? 0 : 1;
		    	set(hitResult.item, pen);
		    }
		}

		function onMouseDrag(event) {
		    var hitResult = project.hitTest(event.point, hitOptions);
		    if (hitResult) {
		    	set(hitResult.item, pen);
		    }
		}

		function onMouseUp(event) {
			hasher.setHash(pickle()); //change hash value (generates new history record)
		}

		//handle hash changes
		function handleChanges(newHash, oldHash){
			unpickle(newHash);
		}

		hasher.changed.add(handleChanges); //add hash change listener
		hasher.initialized.add(handleChanges); //add initialized listener (to grab initial value in case it is already set)
		hasher.init(); //initialize hasher (start listening for history changes)


	</script>
</head>
<body>
	<div id='canvasContainer'>
		<canvas id="canvas" width='480px' height='480px'></canvas>
	</div>
</body>
</html>